@using CypherSheet.Domain
@using CypherSheet.Storage
@inject IDialogService DialogService
@inject ICharacterRepository Repository

<MudStack Spacing="2">
    <MudButton StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Color="Color.Primary" OnClick="AddNote">Adicionar Nota</MudButton>
    
    @if (!Character.Notes.Any())
    {
        <div style="position: relative; min-height: 300px;">
            <EmptyStateWatermark Icon="@Icons.Material.Filled.EditNote" />
        </div>
    }
    else
    {
        <MudGrid>
            @foreach (var note in Character.Notes)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudCard Elevation="2">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">@note.Title</MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                 <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" OnClick="@(() => EditNote(note))" />
                                 <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => RemoveNote(note))" />
                            </CardHeaderActions>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudText Typo="Typo.body2" Style="white-space: pre-wrap;">@note.Content</MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
</MudStack>

@code {
    [Parameter] public Character Character { get; set; }

    private async Task AddNote()
    {
        await OpenNoteDialog(null);
    }
    
    private async Task EditNote(Note note)
    {
        await OpenNoteDialog(note);
    }

    private async Task OpenNoteDialog(Note note)
    {
        var parameters = new DialogParameters { ["Character"] = Character, ["NoteToEdit"] = note };
        var title = note == null ? "Nova Nota" : "Editar Nota";
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        
        var result = await DialogService.Show<AddNoteDialog>(title, parameters, options).Result;
        
        if (!result.Canceled)
        {
             await SaveCharacter();
             StateHasChanged();
        }
    }

    private async Task RemoveNote(Note note)
    {
        Character.Notes.Remove(note);
        await SaveCharacter();
    }
        
    private async Task SaveCharacter()
    {
        await Repository.SaveCharacterAsync(Character);
    }
}
