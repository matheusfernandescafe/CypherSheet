@using CypherSheet.Domain
@using CypherSheet.Storage
@inject ICharacterRepository Repository
@inject IDialogService DialogService
@inject ISnackbar Snackbar

@if (Character == null)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudStack Spacing="2">
        <MudCard Elevation="3">
            <MudCardContent>
                <div class="d-flex justify-space-between align-center">
                    <MudText Typo="Typo.h5">@Character.Name</MudText>
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" OnClick="EditStats" />
                </div>
                <MudText Typo="Typo.body2">@Character.Descriptor @Character.Type que @Character.Focus</MudText>
                <MudText Typo="Typo.body2">Tier @Character.Tier | XP: @Character.XP</MudText>
            </MudCardContent>
        </MudCard>

        <PoolComponent Pool="@Character.Might" OnChange="SaveCharacter" />
        <PoolComponent Pool="@Character.Speed" OnChange="SaveCharacter" />
        <PoolComponent Pool="@Character.Intellect" OnChange="SaveCharacter" />
        
        <MudCard Elevation="3" Class="pa-2">
            <MudCardContent>
                <MudText Typo="Typo.h6">Recovery</MudText>
                <MudStack Row="true" Justify="Justify.SpaceBetween">
                    <MudCheckBox T="bool" Value="@Character.Recovery.OneActionUsed" ValueChanged="@((v) => UpdateRecovery(v, 1))" Label="1 Action" Dense="true" Color="Color.Success" />
                    <MudCheckBox T="bool" Value="@Character.Recovery.TenMinutesUsed" ValueChanged="@((v) => UpdateRecovery(v, 2))" Label="10 Mins" Dense="true" Color="Color.Success" />
                </MudStack>
                <MudStack Row="true" Justify="Justify.SpaceBetween">
                     <MudCheckBox T="bool" Value="@Character.Recovery.OneHourUsed" ValueChanged="@((v) => UpdateRecovery(v, 3))" Label="1 Hour" Dense="true" Color="Color.Success" />
                     <MudCheckBox T="bool" Value="@Character.Recovery.TenHoursUsed" ValueChanged="@((v) => UpdateRecovery(v, 4))" Label="10 Hours" Dense="true" Color="Color.Success" />
                </MudStack>
                 <MudButton Variant="Variant.Outlined" FullWidth="true" OnClick="ResetRecovery" Class="mt-2">Reset Recovery</MudButton>
            </MudCardContent>
        </MudCard>

        <MudCard Elevation="3" Class="pa-2">
            <MudCardContent>
                <MudText Typo="Typo.h6" Class="mb-2">Atributos Adicionais</MudText>
                <MudStack Row="true" Spacing="2">
                    <MudNumericField @bind-Value="Character.Effort" Label="Effort" Variant="Variant.Outlined" Min="0" T="int" OnBlur="SaveCharacter" FullWidth="true" />
                    <MudNumericField @bind-Value="Character.Armor" Label="Armor" Variant="Variant.Outlined" Min="0" T="int" OnBlur="SaveCharacter" FullWidth="true" />
                </MudStack>
            </MudCardContent>
        </MudCard>

        <MudCard Elevation="3" Class="pa-3">
            <MudCardContent>
                <MudText Typo="Typo.h6" Class="mb-3">Marcador de Dano</MudText>
                <MudGrid Spacing="3">
                    <MudItem xs="12" sm="6">
                        <MudCheckBox Value="@Character.Impaired" Label="Enfraquecido" Dense="true" Color="Color.Warning" T="bool" ValueChanged="@((v) => UpdateDamageTrack(v, true))" />
                        <MudText Typo="Typo.caption" Class="ml-8">
                            +1 Effort per level<br/>
                            Ignore minor and major effect results on rolls<br/>
                            Combat roll of 17-20 deals only +1 damage
                        </MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudCheckBox Value="@Character.Debilitated" Label="Debilitado" Dense="true" Color="Color.Error" T="bool" ValueChanged="@((v) => UpdateDamageTrack(v, false))" />
                        <MudText Typo="Typo.caption" Class="ml-8">
                            Can move only an immediate distance<br/>
                            Cannot move if Speed Pool is 0
                        </MudText>
                    </MudItem>
                </MudGrid>
            </MudCardContent>
        </MudCard>

    </MudStack>
}

@code {
    [Parameter] public Character Character { get; set; }
    [Parameter] public EventCallback<Character> CharacterChanged { get; set; }
    [Parameter] public EventCallback OnSave { get; set; }



    private async Task EditStats()
    {
        var parameters = new DialogParameters { ["Character"] = Character };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        
        var dialog = DialogService.Show<EditCharacterDialog>("Editar Personagem", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await SaveCharacter();
        }
    }

    private async Task SaveCharacter()
    {
        await OnSave.InvokeAsync();
    }
    
    private async Task UpdateRecovery(bool value, int type)
    {
        switch (type)
        {
            case 1: Character.Recovery.OneActionUsed = value; break;
            case 2: Character.Recovery.TenMinutesUsed = value; break;
            case 3: Character.Recovery.OneHourUsed = value; break;
            case 4: Character.Recovery.TenHoursUsed = value; break;
        }
        await SaveCharacter();
    }
    
    private async Task ResetRecovery()
    {
        Character.Recovery.Reset();
        await SaveCharacter();
    }
    
    private async Task UpdateDamageTrack(bool value, bool isImpaired)
    {
        if (isImpaired)
        {
            Character.Impaired = value;
        }
        else
        {
            Character.Debilitated = value;
        }
        await SaveCharacter();
    }
}
