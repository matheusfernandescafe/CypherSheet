@using CypherSheet.Domain
@using CypherSheet.Storage
@inject IDialogService DialogService
@inject ICharacterRepository Repository

<MudStack Spacing="2">
    <MudButton StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Color="Color.Primary" OnClick="AddCypher">Adicionar Cypher</MudButton>
    
    @if (!Character.Cyphers.Any())
    {
        <div style="position: relative; min-height: 300px;">
            <EmptyStateWatermark Icon="@Icons.Material.Filled.ChangeHistory" />
            <MudText Typo="Typo.body2" Class="pa-4" style="position: relative; z-index: 1;">Nenhum Cypher encontrado.</MudText>
        </div>
    }
    else
    {
        @foreach (var cypher in Character.Cyphers)
        {
            <MudCard Elevation="2" Class="mb-2">
                <MudCardContent>
                    <MudText Typo="Typo.h6">@cypher.Name <MudText Inline="true" Typo="Typo.caption" Class="ml-2">NÃ­vel @cypher.Level</MudText></MudText>
                    <MudText Typo="Typo.body2">@cypher.Effect</MudText>
                </MudCardContent>
                <MudCardActions>
                     <MudSpacer />
                     <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary" OnClick="@(() => EditCypher(cypher))" />
                     <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => RemoveCypher(cypher))" />
                </MudCardActions>
            </MudCard>
        }
    }
</MudStack>

@code {
    [Parameter] public Character Character { get; set; }

    private async Task AddCypher()
    {
        await OpenCypherDialog(null);
    }
    
    private async Task EditCypher(Cypher cypher)
    {
        await OpenCypherDialog(cypher);
    }

    private async Task OpenCypherDialog(Cypher cypher)
    {
        var parameters = new DialogParameters { ["Character"] = Character, ["CypherToEdit"] = cypher };
        var title = cypher == null ? "Novo Cypher" : "Editar Cypher";
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        
        var result = await DialogService.Show<AddCypherDialog>(title, parameters, options).Result;
        
        if (!result.Canceled)
        {
             await SaveCharacter();
             StateHasChanged();
        }
    }

    private async Task RemoveCypher(Cypher cypher)
    {
        Character.Cyphers.Remove(cypher);
        await SaveCharacter();
    }
    
    private async Task SaveCharacter()
    {
        await Repository.SaveCharacterAsync(Character);
    }
}
