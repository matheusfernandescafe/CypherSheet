@using MudBlazor
@using CypherSheet.Domain
@using CypherSheet.Client.Services
@using CypherSheet.Client.Components.Dialogs
@using CypherSheet.Shared
@inject IDialogService DialogService
@inject IThemeService ThemeService
@inject ILoadingService LoadingService
@inject INotificationService NotificationService
@inject IDataManagementService DataManagementService
@inject ICacheService CacheService
@inject IJSRuntime JSRuntime

<MudContainer MaxWidth="MaxWidth.Medium" Class="pa-4">
    <MudStack Spacing="4">
        <MudText Typo="Typo.h4" Class="mb-4">Configurações</MudText>
        
        <!-- Seção de Idioma -->
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Spacing="3">
                <MudText Typo="Typo.h6">Idioma</MudText>
                <MudListItem T="string" Dense="false" OnClick="OpenLanguageDialog" Style="cursor: pointer; border-radius: 8px;" Class="hover-item">
                    <div class="d-flex align-center justify-space-between width-100">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Language" />
                            <MudText>Idioma da Aplicação</MudText>
                        </MudStack>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudText Typo="Typo.body2" Class="text-muted">Português</MudText>
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Text" Class="ml-2">Em breve</MudChip>
                            <MudIcon Icon="@Icons.Material.Filled.ChevronRight" />
                        </MudStack>
                    </div>
                </MudListItem>
            </MudStack>
        </MudPaper>

        <!-- Seção de Aparência -->
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Spacing="3">
                <MudText Typo="Typo.h6">Aparência</MudText>
                <MudListItem T="string" Dense="false" Style="border-radius: 8px;">
                    <div class="d-flex align-center justify-space-between width-100">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.DarkMode" />
                            <MudText>Modo Escuro</MudText>
                        </MudStack>
                        <MudSwitch T="bool" Value="@ThemeService.IsDarkMode" ValueChanged="@OnDarkModeChanged" Color="Color.Primary" />
                    </div>
                </MudListItem>
            </MudStack>
        </MudPaper>

        <!-- Seção de Dados -->
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Spacing="3">
                <MudText Typo="Typo.h6">Gerenciar Dados</MudText>
                
                <MudListItem T="string" Dense="false" OnClick="ExportCharacter" Style="cursor: pointer; border-radius: 8px;" Class="hover-item" Disabled="LoadingService.IsLoading">
                    <div class="d-flex align-center justify-space-between width-100">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Upload" />
                            <MudText>Exportar Personagem</MudText>
                        </MudStack>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            @if (LoadingService.IsLoading)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Filled.ChevronRight" />
                            }
                        </MudStack>
                    </div>
                </MudListItem>
                
                <MudListItem T="string" Dense="false" OnClick="ImportCharacter" Style="cursor: pointer; border-radius: 8px;" Class="hover-item" Disabled="LoadingService.IsLoading">
                    <div class="d-flex align-center justify-space-between width-100">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Download" />
                            <MudText>Importar Personagem</MudText>
                        </MudStack>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            @if (LoadingService.IsLoading)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Filled.ChevronRight" />
                            }
                        </MudStack>
                    </div>
                </MudListItem>
                
                <MudDivider />
                
                <MudListItem T="string" Dense="false" OnClick="ClearCache" Style="cursor: pointer; border-radius: 8px;" Class="hover-item" Disabled="LoadingService.IsLoading">
                    <div class="d-flex align-center justify-space-between width-100">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.ClearAll" Color="Color.Warning" />
                            <MudText Color="Color.Warning">Deletar Cache</MudText>
                        </MudStack>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            @if (LoadingService.IsLoading)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Color="Color.Warning" />
                            }
                        </MudStack>
                    </div>
                </MudListItem>
                
                <MudListItem T="string" Dense="false" OnClick="DeleteAllData" Style="cursor: pointer; border-radius: 8px;" Class="hover-item" Disabled="LoadingService.IsLoading">
                    <div class="d-flex align-center justify-space-between width-100">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.DeleteForever" Color="Color.Error" />
                            <MudText Color="Color.Error">Deletar Todas as Informações</MudText>
                        </MudStack>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            @if (LoadingService.IsLoading)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Color="Color.Error" />
                            }
                        </MudStack>
                    </div>
                </MudListItem>
            </MudStack>
        </MudPaper>

        <!-- Spacer para empurrar o footer para baixo -->
        <div style="height: 60px;"></div>

        <!-- Footer com informações do projeto -->
        <MudPaper Class="pa-4" Elevation="1" Style="margin-top: auto;">
            <MudStack Spacing="2" AlignItems="AlignItems.Center">
                <MudLink Href="https://github.com/matheusfernandescafe/CypherSheet" Target="_blank" Underline="Underline.Hover">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Custom.Brands.GitHub" Size="Size.Small" />
                        <MudText Typo="Typo.body2">GitHub do Projeto</MudText>
                    </MudStack>
                </MudLink>
                <MudText Typo="Typo.caption" Class="text-muted">@AppVersion.FullVersion</MudText>
            </MudStack>
        </MudPaper>
    </MudStack>
</MudContainer>

<style>
    .hover-item:hover {
        background-color: var(--mud-palette-action-default-hover);
    }
</style>

@code {
    private async Task OnDarkModeChanged(bool value)
    {
        await ThemeService.SetDarkModeAsync(value);
    }

    private async Task OpenLanguageDialog()
    {
        NotificationService.ShowInfo("Funcionalidade de idioma ainda não implementada. Em breve!", "Idioma");
        await Task.CompletedTask;
    }

    private async Task ExportCharacter()
    {
        if (LoadingService.IsLoading) return;

        await LoadingService.ExecuteWithLoadingAsync(async () =>
        {
            var parameters = new DialogParameters();
            var options = new DialogOptions() 
            { 
                CloseButton = true, 
                MaxWidth = MaxWidth.Medium,
                FullWidth = true
            };

            var dialog = await DialogService.ShowAsync<ExportModal>("Exportar Personagens", parameters, options);
            var result = await dialog.Result;

            if (result?.Canceled == false)
            {
                NotificationService.ShowSuccess("Exportação realizada com sucesso!", "Exportação Concluída");
            }
        }, "Preparando exportação...");
    }

    private async Task ImportCharacter()
    {
        if (LoadingService.IsLoading) return;

        await LoadingService.ExecuteWithLoadingAsync(async () =>
        {
            var parameters = new DialogParameters();
            var options = new DialogOptions() 
            { 
                CloseButton = true, 
                MaxWidth = MaxWidth.Medium,
                FullWidth = true
            };

            var dialog = await DialogService.ShowAsync<ImportModal>("Importar Personagens", parameters, options);
            var result = await dialog.Result;

            if (result?.Canceled == false)
            {
                NotificationService.ShowSuccess("Importação realizada com sucesso!", "Importação Concluída");
            }
        }, "Preparando importação...");
    }

    private async Task ClearCache()
    {
        if (LoadingService.IsLoading) return;

        var result = await DialogService.ShowMessageBox(
            "Confirmar Limpeza de Cache",
            "Tem certeza que deseja limpar o cache da aplicação? Isso pode melhorar a performance, mas os dados dos personagens serão preservados.",
            yesText: "Confirmar", 
            cancelText: "Cancelar");

        if (result == true)
        {
            await LoadingService.ExecuteWithLoadingAsync(async () =>
            {
                LoadingService.UpdateLoadingMessage("Limpando cache da aplicação...");
                LoadingService.UpdateProgress(25);

                await CacheService.ClearApplicationCacheAsync();
                
                LoadingService.UpdateProgress(75);
                LoadingService.UpdateLoadingMessage("Finalizando limpeza...");

                NotificationService.ShowCriticalSuccess("Cache limpo com sucesso! A aplicação será recarregada.", "Cache Limpo");

                LoadingService.UpdateProgress(100);
                
                // Recarregar a aplicação após limpar o cache
                await Task.Delay(1500);
                await JSRuntime.InvokeVoidAsync("location.reload", true);
            }, "Iniciando limpeza de cache...");
        }
    }

    private async Task DeleteAllData()
    {
        if (LoadingService.IsLoading) return;

        var parameters = new DialogParameters();
        var options = new DialogOptions() 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<DeleteAllDataDialog>("Deletar Todas as Informações", parameters, options);
        var result = await dialog.Result;

        if (result?.Canceled == false && result.Data is bool success && success)
        {
            await LoadingService.ExecuteWithLoadingAsync(async () =>
            {
                LoadingService.UpdateLoadingMessage("Deletando todos os dados...");
                LoadingService.UpdateProgress(25);

                await DataManagementService.DeleteAllDataAsync();
                
                LoadingService.UpdateProgress(75);
                LoadingService.UpdateLoadingMessage("Finalizando exclusão...");

                NotificationService.ShowCriticalSuccess("Todos os dados foram deletados com sucesso!", "Dados Deletados");

                LoadingService.UpdateProgress(100);
                
                // Recarregar a aplicação após deletar os dados
                await Task.Delay(1500);
                await JSRuntime.InvokeVoidAsync("location.reload", true);
            }, "Iniciando exclusão de dados...");
        }
    }
}