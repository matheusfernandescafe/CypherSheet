@page "/character/{Id:guid}"
@using CypherSheet.Domain
@using CypherSheet.Storage
@using CypherSheet.Client.Components.Views
@inject ICharacterRepository Repository
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>@(character?.Name ?? "Carregando...") - Cypher Sheet</PageTitle>

<style>
    .app-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
    }
    
    .content-area {
        flex: 1;
        overflow-y: auto;
        padding-bottom: 80px;
    }
    
    .custom-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 76px;
        background: var(--mud-palette-surface);
        border-top: 1px solid var(--mud-palette-divider);
        display: flex;
        justify-content: space-around;
        align-items: center;
        z-index: 1000;
        box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
    }
    
    .footer-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex: 1;
        height: 100%;
        cursor: pointer;
        transition: all 0.2s ease;
        color: var(--mud-palette-text-secondary);
        text-decoration: none;
        padding: 4px;
    }
    
    .footer-item:hover:not(.disabled) {
        background: var(--mud-palette-action-default-hover);
    }
    
    .footer-item.active {
        color: var(--mud-palette-primary);
    }
    
    .footer-item.disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }
    
    .footer-item .mud-icon-root {
        font-size: 1.5rem;
    }
    
    .footer-item-label {
        font-size: 0.65rem;
        margin-top: 2px;
        text-align: center;
        line-height: 1;
    }
</style>

@if (isLoading)
{
    <div class="app-container">
        <div class="content-area">
            <MudContainer Class="d-flex justify-center align-center" Style="height: 100vh;">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            </MudContainer>
        </div>
        
        <div class="custom-footer">
            <div class="footer-item disabled">
                <MudIcon Icon="@Icons.Material.Filled.Person" />
                <span class="footer-item-label">Stats</span>
            </div>
            
            <div class="footer-item disabled">
                <MudIcon Icon="@Icons.Material.Filled.SportsMma" />
                <span class="footer-item-label">Skills</span>
            </div>
            
            <div class="footer-item disabled">
                <MudIcon Icon="@Icons.Material.Filled.AutoAwesome" />
                <span class="footer-item-label">Abilities</span>
            </div>
            
            <div class="footer-item disabled">
                <MudIcon Icon="@Icons.Material.Filled.ChangeHistory" />
                <span class="footer-item-label">Cyphers</span>
            </div>
            
            <div class="footer-item disabled">
                <MudIcon Icon="@Icons.Material.Filled.Backpack" />
                <span class="footer-item-label">Equip.</span>
            </div>
            
            <div class="footer-item disabled">
                <MudIcon Icon="@Icons.Material.Filled.EditNote" />
                <span class="footer-item-label">Notes</span>
            </div>
            
            <div class="footer-item" @onclick="@(() => NavigateToTab(TabType.Characters))">
                <MudIcon Icon="@Icons.Material.Filled.Groups" />
                <span class="footer-item-label">Chars</span>
            </div>
            
            <div class="footer-item active" @onclick="@(() => NavigateToTab(TabType.Settings))">
                <MudIcon Icon="@Icons.Material.Filled.Settings" />
                <span class="footer-item-label">Config</span>
            </div>
        </div>
    </div>
}
else if (character == null)
{
    <div class="app-container">
        <div class="content-area">
            @switch (currentTab)
            {
                case TabType.Characters:
                    <div class="d-flex justify-center align-center pa-4">
                        <MudStack Spacing="3" AlignItems="AlignItems.Center">
                            <MudAlert Severity="Severity.Info">Personagem não encontrado.</MudAlert>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => Navigation.NavigateTo(""))">Selecionar Personagem</MudButton>
                        </MudStack>
                    </div>
                    break;
                case TabType.Settings:
                default:
                    <SettingsView />
                    break;
            }
        </div>
        
        <div class="custom-footer">
            <div class="footer-item disabled">
                <MudIcon Icon="@Icons.Material.Filled.Person" />
                <span class="footer-item-label">Stats</span>
            </div>
            
            <div class="footer-item disabled">
                <MudIcon Icon="@Icons.Material.Filled.SportsMma" />
                <span class="footer-item-label">Skills</span>
            </div>
            
            <div class="footer-item disabled">
                <MudIcon Icon="@Icons.Material.Filled.AutoAwesome" />
                <span class="footer-item-label">Abilities</span>
            </div>
            
            <div class="footer-item disabled">
                <MudIcon Icon="@Icons.Material.Filled.ChangeHistory" />
                <span class="footer-item-label">Cyphers</span>
            </div>
            
            <div class="footer-item disabled">
                <MudIcon Icon="@Icons.Material.Filled.Backpack" />
                <span class="footer-item-label">Equip.</span>
            </div>
            
            <div class="footer-item disabled">
                <MudIcon Icon="@Icons.Material.Filled.EditNote" />
                <span class="footer-item-label">Notes</span>
            </div>
            
            <div class="footer-item @(currentTab == TabType.Characters ? "active" : "")" 
                 @onclick="@(() => NavigateToTab(TabType.Characters))">
                <MudIcon Icon="@Icons.Material.Filled.Groups" />
                <span class="footer-item-label">Chars</span>
            </div>
            
            <div class="footer-item @(currentTab == TabType.Settings ? "active" : "")" 
                 @onclick="@(() => NavigateToTab(TabType.Settings))">
                <MudIcon Icon="@Icons.Material.Filled.Settings" />
                <span class="footer-item-label">Config</span>
            </div>
        </div>
    </div>
}
else
{
    <div class="app-container">
        <div class="content-area">
            @switch (currentTab)
            {
                case TabType.Stats:
                    <StatsView Character="character" OnSave="SaveCharacter" />
                    break;
                case TabType.Skills:
                    <SkillsView Character="character" />
                    break;
                case TabType.Abilities:
                    <AbilitiesView Character="character" />
                    break;
                case TabType.Cyphers:
                    <CyphersView Character="character" />
                    break;
                case TabType.Equipment:
                    <EquipmentView Character="character" />
                    break;
                case TabType.Notes:
                    <NotesView Character="character" />
                    break;
                case TabType.Characters:
                    <div class="d-flex justify-center align-center pa-4">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => Navigation.NavigateTo(""))">Trocar Personagem</MudButton>
                    </div>
                    break;
                case TabType.Settings:
                    <SettingsView />
                    break;
            }
        </div>
        
        <div class="custom-footer">
            <div class="footer-item @(currentTab == TabType.Stats ? "active" : "") @(character == null ? "disabled" : "")" 
                 @onclick="@(() => NavigateToTab(TabType.Stats))">
                <MudIcon Icon="@Icons.Material.Filled.Person" />
                <span class="footer-item-label">Stats</span>
            </div>
            
            <div class="footer-item @(currentTab == TabType.Skills ? "active" : "") @(character == null ? "disabled" : "")" 
                 @onclick="@(() => NavigateToTab(TabType.Skills))">
                <MudIcon Icon="@Icons.Material.Filled.SportsMma" />
                <span class="footer-item-label">Skills</span>
            </div>
            
            <div class="footer-item @(currentTab == TabType.Abilities ? "active" : "") @(character == null ? "disabled" : "")" 
                 @onclick="@(() => NavigateToTab(TabType.Abilities))">
                <MudIcon Icon="@Icons.Material.Filled.AutoAwesome" />
                <span class="footer-item-label">Abilities</span>
            </div>
            
            <div class="footer-item @(currentTab == TabType.Cyphers ? "active" : "") @(character == null ? "disabled" : "")" 
                 @onclick="@(() => NavigateToTab(TabType.Cyphers))">
                <MudIcon Icon="@Icons.Material.Filled.ChangeHistory" />
                <span class="footer-item-label">Cyphers</span>
            </div>
            
            <div class="footer-item @(currentTab == TabType.Equipment ? "active" : "") @(character == null ? "disabled" : "")" 
                 @onclick="@(() => NavigateToTab(TabType.Equipment))">
                <MudIcon Icon="@Icons.Material.Filled.Backpack" />
                <span class="footer-item-label">Equip.</span>
            </div>
            
            <div class="footer-item @(currentTab == TabType.Notes ? "active" : "") @(character == null ? "disabled" : "")" 
                 @onclick="@(() => NavigateToTab(TabType.Notes))">
                <MudIcon Icon="@Icons.Material.Filled.EditNote" />
                <span class="footer-item-label">Notes</span>
            </div>
            
            <div class="footer-item @(currentTab == TabType.Characters ? "active" : "")" 
                 @onclick="@(() => NavigateToTab(TabType.Characters))">
                <MudIcon Icon="@Icons.Material.Filled.Groups" />
                <span class="footer-item-label">Chars</span>
            </div>
            
            <div class="footer-item @(currentTab == TabType.Settings ? "active" : "")" 
                 @onclick="@(() => NavigateToTab(TabType.Settings))">
                <MudIcon Icon="@Icons.Material.Filled.Settings" />
                <span class="footer-item-label">Config</span>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public Guid Id { get; set; }
    
    private Character character;
    private bool isLoading = true;

    private enum TabType { Stats, Skills, Abilities, Cyphers, Equipment, Notes, Characters, Settings }
    private TabType currentTab = TabType.Stats;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        character = await Repository.GetCharacterAsync(Id);
        
        // Se não há personagem, definir Settings como aba padrão
        if (character == null)
        {
            currentTab = TabType.Settings;
        }
        
        isLoading = false;
    }

    private void NavigateToTab(TabType tab)
    {
        // Permitir navegação apenas para abas disponíveis quando não há personagem
        if (character == null && tab != TabType.Characters && tab != TabType.Settings)
        {
            return; // Não fazer nada se tentar acessar aba desabilitada
        }
        
        currentTab = tab;
    }

    private async Task SaveCharacter()
    {
        if (character != null)
        {
            await Repository.SaveCharacterAsync(character);
        }
    }
}
