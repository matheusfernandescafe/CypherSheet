@page "/character/{Id:guid}"
@using CypherSheet.Domain
@using CypherSheet.Storage
@using CypherSheet.Client.Components.Views
@inject ICharacterRepository Repository
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>@(character?.Name ?? "Carregando...") - Cypher Sheet</PageTitle>

@if (isLoading)
{
    <MudContainer Class="d-flex justify-center align-center" Style="height: 100vh;">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    </MudContainer>
}
else if (character == null)
{
    <MudAlert Severity="Severity.Error">Personagem não encontrado.</MudAlert>
    <MudButton Variant="Variant.Text" OnClick="@(() => Navigation.NavigateTo("/"))">Voltar</MudButton>
}
else
{
    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4" Position="Position.Bottom" Color="Color.Surface" SliderColor="Color.Primary" ActiveTabClass="mud-text-primary" Centered="true">
        <MudTabPanel Icon="@Icons.Material.Filled.Person" ToolTip="Stats">
            <StatsView Character="character" OnSave="SaveCharacter" />
        </MudTabPanel>
        <MudTabPanel Icon="@Icons.Material.Filled.SportsMma" ToolTip="Skills">
            <SkillsView Character="character" />
        </MudTabPanel>
        <MudTabPanel Icon="@Icons.Material.Filled.AutoAwesome" ToolTip="Abilities">
            <AbilitiesView Character="character" />
        </MudTabPanel>
        <MudTabPanel Icon="@Icons.Material.Filled.ChangeHistory" ToolTip="Cyphers">
            <CyphersView Character="character" />
        </MudTabPanel>
        <MudTabPanel Icon="@Icons.Material.Filled.Backpack" ToolTip="Equipment">
            <EquipmentView Character="character" />
        </MudTabPanel>
        <MudTabPanel Icon="@Icons.Material.Filled.EditNote" ToolTip="Notes">
            <NotesView Character="character" />
        </MudTabPanel>
        <MudTabPanel Icon="@Icons.Material.Filled.Groups" ToolTip="Personagens" OnClick="@(() => Navigation.NavigateTo("/"))">
             <div class="d-flex justify-center align-center pa-4">
                 <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => Navigation.NavigateTo("/"))">Trocar Personagem</MudButton>
             </div>
        </MudTabPanel>
    </MudTabs>
}

@code {
    [Parameter] public Guid Id { get; set; }
    
    private Character character;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        character = await Repository.GetCharacterAsync(Id);
        isLoading = false;
    }

    private async Task SaveCharacter()
    {
        if (character != null)
        {
            await Repository.SaveCharacterAsync(character);
        }
    }
}
